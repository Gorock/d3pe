<!DOCTYPE html>
<html lang="en" data-bs-theme="black">
  <header>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="d3.min.js"></script>
    <script src="plot.min.js"></script>
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  </header>

  <body class="text-bg-dark">
    <main>
      <div class="container">
        <header class="d-flex justify-content-center py-3">
          <ul class="nav nav-pills">
            <li class="nav-item"> <a href="." class="nav-link active" aria-current="page" >Market Stocküì¶</a > </li>
            <li class="nav-item"> <a href="stable-stock.html" class="nav-link">Stables Stocksüê¥</a></li>
            <li class="nav-item"><a href="weapon-stock.html" class="nav-link">Weapon Stock‚öîÔ∏è</a></li>
          </ul>
        </header>
      </div>
    </main>
    <div class="container">
      <div id="myplot"></div>
      <div id="myplot2"></div>
    </div>

    <script type="module">
      const data = await d3.csv("stocks/market-stock.csv", (row) => {
        return {
          time: new Date(row.time),
          resource: row.resource,
          ammount: +row.ammount,
        };
      });
      console.log(data);
      const div = document.querySelector("#myplot");
      const div2 = document.querySelector("#myplot2");

      const sd = d3.sort(data, (a, b) => d3.descending(a.time, b.time));
      const gtime = d3.group(data, (d) => d.time);
      const newest = gtime.get(sd[0].time);
      const plot = Plot.plot({
        marginLeft: 95,
        marginRight: 100,
        x: {
          axis: "top",
          grid: true,
        },
        color: { scheme: "category10", legend: false },
        marks: [
          Plot.barX(newest, {
            y: "resource",
            x: "ammount",
            fill: "resource",
            fy: "time",
            sort: { y: null, color: null, fy: { value: "-x", reduce: "sum" } },
            tip: true,
          }),
          Plot.ruleX([0]),
          Plot.text(newest, {
            text: (d) => d.ammount,
            fy: "time",
            y: "resource",
            x: 2,
            fontWeight: 600,
            textAnchor: "start",
            dx: 3,
            fill: "white",
          }),
        ],
      });

      const plot2 = Plot.plot({
        grid: true,
        nice: true,
        color: { scheme: "category10", legend: false },

        marks: [
          Plot.ruleY([0]),
          Plot.lineY(data, {
            x: "time",
            y: "ammount",
            stroke: "resource",
            tip: "x",
            marker: false,
          }),
          Plot.text(
            data,
            Plot.selectLast({
              x: "time",
              y: "ammount",
              z: "resource",
              text: "resource",
              textAnchor: "start",
              dx: 3,
            })
          ),
          Plot.axisX(),
          Plot.axisY({ ticks: 50, text: null, tickSize: 3 }),
          Plot.axisY(),
          // Plot.text(data, {x: "time", y: "ammount", z: "resource", text: "ammount", textAnchor: "start", dy: -8})
        ],
      });

      div.append(plot);
      div2.append(plot2);
    </script>
  </body>
</html>
